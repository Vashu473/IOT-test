<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Audio Receiver</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .container {
        width: 100%;
        max-width: 800px;
      }

      canvas {
        width: 100%;
        height: 200px;
        background-color: #f0f0f0;
        margin-bottom: 20px;
        border: 1px solid #ddd;
      }

      .slider-container {
        width: 100%;
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      #volumeSlider {
        flex: 1;
        margin: 0 10px;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      button {
        padding: 8px 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background-color: #45a049;
      }

      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .status {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .debug-panel {
        width: 100%;
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        background-color: #f8f8f8;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ESP32 Audio Receiver</h1>

      <div class="status" id="statusContainer">
        WebSocket: <span id="wsStatus">Disconnected</span><br />
        Microphone: <span id="micStatus">Disabled</span><br />
        Audio Packets: <span id="packetCount">0</span><br />
        Last RMS: <span id="lastRms">0</span>
      </div>

      <div class="controls">
        <button id="enableMic">Enable Microphone</button>
        <button id="disableMic">Disable Microphone</button>
      </div>

      <canvas id="audioVisualizer"></canvas>

      <div class="slider-container">
        <span>Volume:</span>
        <input
          type="range"
          id="volumeSlider"
          min="0"
          max="2"
          step="0.1"
          value="1"
        />
        <span id="volumeValue">100%</span>
      </div>

      <h3>Debug Information</h3>
      <div class="debug-panel" id="debugPanel"></div>
    </div>

    <script>
      // Audio context
      let audioContext;
      let gainNode;

      // WebSocket
      let socket;
      let wsConnected = false;
      let micEnabled = false;
      let packetCount = 0;
      let lastRmsValue = 0;

      // Canvas and visualization
      const canvas = document.getElementById("audioVisualizer");
      const ctx = canvas.getContext("2d");

      // Set canvas dimensions with devicePixelRatio for sharp rendering
      function setupCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
      }

      // Debug logging function
      function log(message, isError = false) {
        const debugPanel = document.getElementById("debugPanel");
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement("div");

        if (isError) {
          entry.style.color = "red";
          console.error(message);
        }

        entry.textContent = `[${timestamp}] ${message}`;
        debugPanel.appendChild(entry);
        debugPanel.scrollTop = debugPanel.scrollHeight;

        // Keep a reasonable number of log entries (max 100)
        while (debugPanel.childNodes.length > 100) {
          debugPanel.removeChild(debugPanel.firstChild);
        }
      }

      // Update status display
      function updateStatus() {
        document.getElementById("wsStatus").textContent = wsConnected
          ? "Connected"
          : "Disconnected";
        document.getElementById("wsStatus").style.color = wsConnected
          ? "green"
          : "red";

        document.getElementById("micStatus").textContent = micEnabled
          ? "Enabled"
          : "Disabled";
        document.getElementById("micStatus").style.color = micEnabled
          ? "green"
          : "red";

        document.getElementById("packetCount").textContent = packetCount;
        document.getElementById("lastRms").textContent =
          lastRmsValue.toFixed(2);
      }

      // Initialize WebSocket connection
      function connectWebSocket() {
        // Close existing connection if any
        if (socket) {
          socket.close();
        }

        // Determine WebSocket URL
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}`;

        log(`Connecting to WebSocket server at ${wsUrl}...`);

        socket = new WebSocket(wsUrl);

        socket.onopen = function () {
          wsConnected = true;
          log("WebSocket connection established");
          updateStatus();

          // Identify as a browser client
          socket.send(
            JSON.stringify({
              type: "hello",
              client: "browser",
            })
          );
        };

        socket.onclose = function (event) {
          wsConnected = false;
          log(
            `WebSocket connection closed (code: ${event.code}${
              event.reason ? ", reason: " + event.reason : ""
            })`
          );
          updateStatus();

          // Try to reconnect after a delay
          setTimeout(connectWebSocket, 2000);
        };

        socket.onerror = function (error) {
          log(`WebSocket error occurred`, true);
          wsConnected = false;
          updateStatus();
        };

        socket.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);

            // Handle status updates
            if (data.type === "status") {
              log(
                `Status update - Clients: ${data.clients}, ESP32: ${data.esp32Devices}, Browsers: ${data.browserClients}`
              );
            }
            // Handle info messages
            else if (data.type === "info") {
              log(`Server info: ${data.message}`);
            }
            // Handle PCM audio data
            else if (
              data.type === "audio" &&
              data.format === "pcm" &&
              Array.isArray(data.data)
            ) {
              // Check if we have actual data (non-zero values)
              let hasNonZero = false;
              let maxValue = 0;
              let rmsValue = 0;

              // Calculate RMS and max amplitude
              if (data.data.length > 0) {
                const sumSquared = data.data.reduce((sum, sample) => {
                  const value = Math.abs(sample);
                  maxValue = Math.max(maxValue, value);
                  hasNonZero = hasNonZero || value > 0;
                  return sum + sample * sample;
                }, 0);

                rmsValue = Math.sqrt(sumSquared / data.data.length);
                lastRmsValue = rmsValue;
              }

              // Log audio packet details occasionally
              packetCount++;
              if (packetCount % 20 === 0) {
                log(
                  `Audio packet #${packetCount} - Length: ${
                    data.data.length
                  }, Max: ${maxValue}, RMS: ${rmsValue.toFixed(2)}`
                );
              }

              // Update status
              updateStatus();

              // Only visualize if we have actual data
              if (hasNonZero) {
                visualizeAudio(data.data, maxValue);
              } else {
                log(`Received audio packet with all zeros`, true);
              }
            }
          } catch (error) {
            log(`Error processing message: ${error.message}`, true);
          }
        };
      }

      // Draw audio visualization
      function visualizeAudio(pcmData, maxAmplitude) {
        if (!canvas.width || !canvas.height) {
          setupCanvas();
        }

        // Clear canvas
        ctx.clearRect(
          0,
          0,
          canvas.width / window.devicePixelRatio,
          canvas.height / window.devicePixelRatio
        );

        const width = canvas.width / window.devicePixelRatio;
        const height = canvas.height / window.devicePixelRatio;
        const centerY = height / 2;

        // Draw waveform
        ctx.beginPath();
        ctx.strokeStyle = "#0066cc";
        ctx.lineWidth = 2;

        // Dynamic scaling based on the maximum amplitude
        const scaleFactor = Math.min(1, 32767 / Math.max(maxAmplitude, 1000));
        const amplitudeScale = (height / 2) * 0.9 * scaleFactor;

        const sliceSize = Math.max(1, Math.floor(pcmData.length / width));

        for (let i = 0; i < width; i++) {
          const dataIndex = Math.min(i * sliceSize, pcmData.length - 1);
          const sample = pcmData[dataIndex] || 0;
          const y = centerY - (sample / 32767) * amplitudeScale;

          if (i === 0) {
            ctx.moveTo(i, y);
          } else {
            ctx.lineTo(i, y);
          }
        }

        ctx.stroke();
      }

      // Add event listeners
      document
        .getElementById("enableMic")
        .addEventListener("click", function () {
          if (wsConnected) {
            log("Sending mic_on command");
            socket.send(
              JSON.stringify({
                type: "command",
                action: "mic_on",
              })
            );
            micEnabled = true;
            updateStatus();
          } else {
            log("Cannot enable microphone - WebSocket not connected", true);
          }
        });

      document
        .getElementById("disableMic")
        .addEventListener("click", function () {
          if (wsConnected) {
            log("Sending mic_off command");
            socket.send(
              JSON.stringify({
                type: "command",
                action: "mic_off",
              })
            );
            micEnabled = false;
            updateStatus();
          } else {
            log("Cannot disable microphone - WebSocket not connected", true);
          }
        });

      // Volume control
      const volumeSlider = document.getElementById("volumeSlider");
      const volumeValue = document.getElementById("volumeValue");

      volumeSlider.addEventListener("input", function () {
        const volume = parseFloat(volumeSlider.value);
        volumeValue.textContent = `${Math.round(volume * 100)}%`;

        if (gainNode) {
          gainNode.gain.value = volume;
        }
      });

      // Initialize
      function initialize() {
        setupCanvas();
        connectWebSocket();

        // Initialize Audio Context
        try {
          window.AudioContext =
            window.AudioContext || window.webkitAudioContext;
          audioContext = new AudioContext();
          gainNode = audioContext.createGain();
          gainNode.gain.value = parseFloat(volumeSlider.value);
          gainNode.connect(audioContext.destination);

          log("Audio context initialized");
        } catch (error) {
          log(`Failed to initialize audio context: ${error.message}`, true);
        }

        // Handle window resize
        window.addEventListener("resize", setupCanvas);

        log("Application initialized");
        updateStatus();
      }

      // Start application
      initialize();
    </script>
  </body>
</html>
